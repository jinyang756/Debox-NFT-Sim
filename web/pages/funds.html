<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私募基金行情</title>
    <link rel="stylesheet" href="../assets/style.css">
    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        .fund-list {
            padding: 10px;
        }
        
        .fund-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .fund-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .fund-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .fund-nav {
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .fund-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .fund-manager {
            color: #3498db;
        }
        
        .fund-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .insight-list {
            margin-top: 20px;
        }
        
        .insight-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .insight-card h4 {
            margin-top: 0;
            color: #333;
        }
        
        .insight-card p {
            margin: 10px 0;
            color: #666;
        }
        
        .insight-card span {
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>私募基金行情</h1>
            <nav class="nav">
                <a href="index.html">首页</a>
                <a href="market.html">行情</a>
                <a href="trade.html">交易</a>
                <a href="funds.html" class="active">基金</a>
                <a href="profile.html">我的</a>
            </nav>
        </header>
        
        <main class="main">
            <div class="fund-list" id="fundList">
                <div class="loading">加载中...</div>
            </div>
            
            <!-- 净值图表容器 -->
            <div class="chart-container" id="chartContainer"></div>
            
            <!-- 基金详情模态框 -->
            <div id="fundDetailModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeFundDetail()">&times;</span>
                    <div id="fundDetailContent"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 当前选中的基金ID
        let currentFundId = null;
        
        // 页面加载完成后获取基金数据
        document.addEventListener('DOMContentLoaded', function() {
            loadFunds();
        });
        
        // 加载基金数据
        async function loadFunds() {
            const fundListElement = document.getElementById('fundList');
            
            try {
                const response = await fetch('/api/funds');
                const funds = await response.json();
                
                if (funds.length === 0) {
                    fundListElement.innerHTML = '<div class="error">暂无基金数据</div>';
                    return;
                }
                
                // 渲染基金列表
                fundListElement.innerHTML = funds.map(fund => `
                    <div class="fund-card">
                        <div class="fund-header">
                            <div class="fund-name">${fund.name}</div>
                            <div class="fund-nav">${fund.nav.toFixed(4)}</div>
                        </div>
                        <div class="fund-details">
                            <div>风险等级: ${fund.risk_level}</div>
                            <div class="fund-manager">管理人: ${getFundManager(fund.fund_id)}</div>
                        </div>
                        <div class="fund-details">
                            <div>总收益: ${fund.total_return.toFixed(2)}%</div>
                            <div>最低投资: ¥${fund.min_investment.toLocaleString()}</div>
                        </div>
                        <div class="fund-actions">
                            <button class="btn btn-primary" onclick="viewFundDetail('${fund.fund_id}')">查看详情</button>
                            <button class="btn btn-secondary" onclick="loadFundChart('${fund.fund_id}')">净值图表</button>
                            <button class="btn btn-success" onclick="viewFundInsights('${fund.fund_id}')">市场观点</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载基金数据失败:', error);
                fundListElement.innerHTML = '<div class="error">加载基金数据失败</div>';
            }
        }
        
        // 获取基金经理
        function getFundManager(fundId) {
            const managers = {
                "FUND_K8": "李量",
                "FUND_A1": "张银河",
                "FUND_FIRE": "王萤火",
                "FUND_QUANT": "陈量化",
                "FUND_STABLE": "刘稳健",
                "FUND_GROWTH": "赵成长",
                "FUND_BALANCED": "孙平衡"
            };
            
            return managers[fundId] || "未知经理";
        }
        
        // 查看基金详情
        async function viewFundDetail(fundId) {
            try {
                // 获取基金详情数据
                const response = await fetch(`/api/funds/${fundId}/detail`);
                const fundDetail = await response.json();
                
                // 显示模态框
                const modal = document.getElementById('fundDetailModal');
                const content = document.getElementById('fundDetailContent');
                
                content.innerHTML = `
                    <h2>${getFundName(fundId)}</h2>
                    <p><strong>管理人：</strong>${fundDetail.manager || getFundManager(fundId)}</p>
                    <p><strong>策略类型：</strong>${fundDetail.strategy || getFundStrategy(fundId)}</p>
                    <p><strong>费率结构：</strong>${fundDetail.fee_rate || getFundFeeRate(fundId)}</p>
                    <p><strong>开放状态：</strong>${fundDetail.open_status || '开放认购'}</p>
                    <button class="btn btn-primary" onclick="closeFundDetail()">关闭</button>
                `;
                
                modal.style.display = 'block';
                currentFundId = fundId;
            } catch (error) {
                console.error('获取基金详情失败:', error);
                alert('获取基金详情失败');
            }
        }
        
        // 关闭基金详情
        function closeFundDetail() {
            const modal = document.getElementById('fundDetailModal');
            modal.style.display = 'none';
        }
        
        // 获取基金名称
        function getFundName(fundId) {
            const names = {
                "FUND_K8": "聚财日斗K8基金",
                "FUND_A1": "聚财银河A1基金",
                "FUND_FIRE": "聚财幻方萤火基金",
                "FUND_QUANT": "聚财量化基金",
                "FUND_STABLE": "聚财稳健增长基金",
                "FUND_GROWTH": "聚财成长优选基金",
                "FUND_BALANCED": "聚财平衡配置基金"
            };
            
            return names[fundId] || "未知基金";
        }
        
        // 获取投资策略
        function getFundStrategy(fundId) {
            const strategies = {
                "FUND_K8": "量化多因子对冲",
                "FUND_A1": "宏观对冲策略",
                "FUND_FIRE": "量化选股策略",
                "FUND_QUANT": "指数增强策略",
                "FUND_STABLE": "固定收益策略",
                "FUND_GROWTH": "成长股投资策略",
                "FUND_BALANCED": "股债平衡策略"
            };
            
            return strategies[fundId] || "未知策略";
        }
        
        // 获取费率结构
        function getFundFeeRate(fundId) {
            const feeRates = {
                "FUND_K8": "管理费: 1.5% + 业绩报酬: 20%",
                "FUND_A1": "管理费: 2.0% + 业绩报酬: 25%",
                "FUND_FIRE": "管理费: 1.0% + 业绩报酬: 15%",
                "FUND_QUANT": "管理费: 0.8% + 业绩报酬: 10%",
                "FUND_STABLE": "管理费: 1.2% + 业绩报酬: 8%",
                "FUND_GROWTH": "管理费: 1.8% + 业绩报酬: 15%",
                "FUND_BALANCED": "管理费: 1.5% + 业绩报酬: 12%"
            };
            
            return feeRates[fundId] || "未知费率";
        }
        
        // 加载基金图表
        async function loadFundChart(fundId) {
            try {
                // 显示图表容器
                const chartContainer = document.getElementById('chartContainer');
                chartContainer.style.display = 'block';
                
                // 滚动到图表位置
                chartContainer.scrollIntoView({ behavior: 'smooth' });
                
                // 显示加载中
                chartContainer.innerHTML = '<div class="loading">加载净值数据中...</div>';
                
                // 获取基金净值数据
                const response = await fetch(`/api/funds/${fundId}/nav-history`);
                const navHistory = await response.json();
                
                if (!navHistory || navHistory.length === 0) {
                    chartContainer.innerHTML = '<div class="error">暂无净值数据</div>';
                    return;
                }
                
                // 准备图表数据
                const dates = navHistory.map(item => item.date);
                const navValues = navHistory.map(item => item.nav);
                
                // 初始化图表
                const chart = echarts.init(chartContainer);
                
                // 图表配置
                const option = {
                    title: {
                        text: `${getFundName(fundId)} - 净值走势`,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const date = params[0].axisValue;
                            const nav = params[0].data;
                            return `${date}<br/>净值: ${nav}`;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: dates
                    },
                    yAxis: {
                        type: 'value',
                        scale: true,
                        axisLabel: {
                            formatter: function (value) {
                                return value.toFixed(4);
                            }
                        }
                    },
                    series: [{
                        name: '净值',
                        type: 'line',
                        data: navValues,
                        smooth: true,
                        lineStyle: {
                            color: '#3eaf7c'
                        },
                        itemStyle: {
                            color: '#3eaf7c'
                        },
                        areaStyle: {
                            color: 'rgba(62, 175, 124, 0.1)'
                        }
                    }]
                };
                
                // 渲染图表
                chart.setOption(option);
                
                // 窗口大小改变时重置图表大小
                window.addEventListener('resize', function() {
                    chart.resize();
                });
                
            } catch (error) {
                console.error('加载基金图表失败:', error);
                document.getElementById('chartContainer').innerHTML = '<div class="error">加载净值图表失败</div>';
            }
        }
        
        // 查看基金市场观点
        async function viewFundInsights(fundId) {
            try {
                // 获取基金市场观点数据
                const response = await fetch(`/api/funds/${fundId}/insights`);
                const insights = await response.json();
                
                // 显示模态框
                const modal = document.getElementById('fundDetailModal');
                const content = document.getElementById('fundDetailContent');
                
                if (!insights || insights.length === 0) {
                    content.innerHTML = `
                        <h2>${getFundName(fundId)} - 市场观点</h2>
                        <p>暂无市场观点数据</p>
                        <button class="btn btn-primary" onclick="closeFundDetail()">关闭</button>
                    `;
                } else {
                    const insightsHtml = insights.map(item => `
                        <div class="insight-card">
                            <h4>${item.title}</h4>
                            <p>${item.content}</p>
                            <span>${item.date}</span>
                        </div>
                    `).join('');
                    
                    content.innerHTML = `
                        <h2>${getFundName(fundId)} - 市场观点</h2>
                        <div class="insight-list">
                            ${insightsHtml}
                        </div>
                        <button class="btn btn-primary" onclick="closeFundDetail()">关闭</button>
                    `;
                }
                
                modal.style.display = 'block';
                currentFundId = fundId;
            } catch (error) {
                console.error('获取基金市场观点失败:', error);
                alert('获取基金市场观点失败');
            }
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('fundDetailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>