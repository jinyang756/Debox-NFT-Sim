<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期权行情</title>
    <link rel="stylesheet" href="../css/style.css">
    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        .market-container {
            padding: 10px;
        }
        
        .option-list {
            margin-bottom: 20px;
        }
        
        .option-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-name {
            font-size: 18px;
            font-weight: bold;
            color: #FF7D00; /* 期权主题色 */
        }
        
        .option-price {
            font-size: 20px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .option-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .matrix-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .matrix-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .matrix-table th, .matrix-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .matrix-table th {
            background-color: #f2f2f2;
        }
        
        .call-cell {
            color: #27ae60;
            font-weight: bold;
        }
        
        .put-cell {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #FF7D00; /* 期权主题色 */
            color: white;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .cycle-selector {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .cycle-btn {
            padding: 5px 10px;
            margin: 0 5px;
            border: 1px solid #FF7D00;
            background: white;
            color: #FF7D00;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .cycle-btn.active {
            background: #FF7D00;
            color: white;
        }
        
        .greek-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .greek-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .greek-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .greek-item {
            text-align: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .greek-value {
            font-size: 18px;
            font-weight: bold;
            color: #FF7D00;
        }
        
        .greek-label {
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>期权行情</h1>
            <nav class="nav">
                <a href="index.html">首页</a>
                <a href="market.html" class="active">行情</a>
                <a href="trade.html">交易</a>
                <a href="profile.html">我的</a>
            </nav>
        </header>
        
        <main class="main">
            <div class="market-container">
                <div class="option-list" id="optionList">
                    <div class="loading">加载中...</div>
                </div>
                
                <div class="cycle-selector" id="cycleSelector" style="display: none;">
                    <button class="cycle-btn active" data-cycle="1m">1分钟</button>
                    <button class="cycle-btn" data-cycle="5m">5分钟</button>
                    <button class="cycle-btn" data-cycle="10m">10分钟</button>
                </div>
                
                <div class="chart-container" id="volatilityChartContainer" style="display: none;"></div>
                
                <div class="matrix-container" id="matrixContainer" style="display: none;">
                    <div class="matrix-header">T型报价表</div>
                    <div id="matrixContent"></div>
                </div>
                
                <div class="greek-panel" id="greekPanel" style="display: none;">
                    <div class="greek-header">希腊值</div>
                    <div class="greek-grid" id="greekContent"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 当前选中的期权
        let currentOption = null;
        // 当前周期
        let currentCycle = '1m';
        
        // 页面加载完成后获取期权数据
        document.addEventListener('DOMContentLoaded', function() {
            loadOptions();
            
            // 绑定周期选择器事件
            document.querySelectorAll('.cycle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 更新活动按钮
                    document.querySelectorAll('.cycle-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 更新周期
                    currentCycle = this.dataset.cycle;
                    
                    // 重新加载波动率图表
                    if (currentOption) {
                        loadVolatilityChart(currentOption.symbol);
                    }
                });
            });
        });
        
        // 加载期权数据
        async function loadOptions() {
            const optionListElement = document.getElementById('optionList');
            
            try {
                const response = await fetch('/api/option-market');
                const options = await response.json();
                
                if (options.length === 0) {
                    optionListElement.innerHTML = '<div class="error">暂定期权数据</div>';
                    return;
                }
                
                // 渲染期权列表
                optionListElement.innerHTML = options.map(option => `
                    <div class="option-card" data-symbol="${option.id}">
                        <div class="option-header">
                            <div class="option-name">${option.name}</div>
                            <div class="option-price">${option.currentPrice.toFixed(2)}</div>
                        </div>
                        <div class="option-details">
                            <div>到期日: ${option.expiryDate}</div>
                            <div>行权价: ${option.strikePrice.toFixed(2)}</div>
                        </div>
                        <div class="option-details">
                            <button class="btn btn-primary" onclick="viewVolatilityChart('${option.id}')">波动率</button>
                            <button class="btn btn-secondary" onclick="viewMatrix('${option.id}')">报价表</button>
                            <button class="btn btn-secondary" onclick="viewGreeks('${option.id}')">希腊值</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载期权数据失败:', error);
                optionListElement.innerHTML = '<div class="error">加载期权数据失败</div>';
            }
        }
        
        // 查看波动率图表
        async function viewVolatilityChart(symbol) {
            currentOption = { symbol: symbol };
            
            // 显示图表容器和周期选择器
            document.getElementById('volatilityChartContainer').style.display = 'block';
            document.getElementById('cycleSelector').style.display = 'flex';
            document.getElementById('matrixContainer').style.display = 'none';
            document.getElementById('greekPanel').style.display = 'none';
            
            // 滚动到图表位置
            document.getElementById('volatilityChartContainer').scrollIntoView({ behavior: 'smooth' });
            
            // 加载波动率图表数据
            loadVolatilityChart(symbol);
        }
        
        // 加载波动率图表
        async function loadVolatilityChart(symbol) {
            try {
                const chartContainer = document.getElementById('volatilityChartContainer');
                chartContainer.innerHTML = '<div class="loading">加载波动率数据中...</div>';
                
                // 模拟波动率数据
                const volatilityData = generateMockVolatilityData();
                
                // 准备图表数据
                const times = volatilityData.map(item => item.time);
                const volatilities = volatilityData.map(item => item.volatility);
                
                // 初始化图表
                const chart = echarts.init(chartContainer);
                
                // 图表配置
                const option = {
                    title: {
                        text: `${getOptionName(symbol)} - 隐含波动率`,
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            const time = params[0].axisValue;
                            const volatility = params[0].data;
                            return `${time}<br/>波动率: ${volatility.toFixed(2)}%`;
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: times
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            formatter: function (value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    series: [{
                        name: '隐含波动率',
                        type: 'line',
                        data: volatilities,
                        smooth: true,
                        lineStyle: {
                            color: '#FF7D00'
                        },
                        itemStyle: {
                            color: '#FF7D00'
                        },
                        areaStyle: {
                            color: 'rgba(255, 125, 0, 0.1)'
                        }
                    }]
                };
                
                // 渲染图表
                chart.setOption(option);
                
                // 窗口大小改变时重置图表大小
                window.addEventListener('resize', function() {
                    chart.resize();
                });
                
            } catch (error) {
                console.error('加载波动率图表失败:', error);
                document.getElementById('volatilityChartContainer').innerHTML = '<div class="error">加载波动率图表失败</div>';
            }
        }
        
        // 查看T型报价表
        async function viewMatrix(symbol) {
            currentOption = { symbol: symbol };
            
            // 显示报价表容器
            document.getElementById('matrixContainer').style.display = 'block';
            document.getElementById('volatilityChartContainer').style.display = 'none';
            document.getElementById('cycleSelector').style.display = 'none';
            document.getElementById('greekPanel').style.display = 'none';
            
            // 滚动到报价表位置
            document.getElementById('matrixContainer').scrollIntoView({ behavior: 'smooth' });
            
            // 加载T型报价表数据
            loadMatrix(symbol);
        }
        
        // 加载T型报价表数据
        async function loadMatrix(symbol) {
            try {
                const matrixContainer = document.getElementById('matrixContent');
                matrixContainer.innerHTML = '<div class="loading">加载报价表数据中...</div>';
                
                // 模拟T型报价表数据
                const matrixData = generateMockMatrixData();
                
                // 渲染T型报价表
                let tableHtml = `
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th>行权价</th>
                                <th>Call价格</th>
                                <th>Put价格</th>
                                <th>Call成交量</th>
                                <th>Put成交量</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                matrixData.forEach(row => {
                    tableHtml += `
                        <tr>
                            <td>${row.strikePrice.toFixed(2)}</td>
                            <td class="call-cell">${row.callPrice.toFixed(2)}</td>
                            <td class="put-cell">${row.putPrice.toFixed(2)}</td>
                            <td>${row.callVolume}</td>
                            <td>${row.putVolume}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                matrixContainer.innerHTML = tableHtml;
            } catch (error) {
                console.error('加载T型报价表数据失败:', error);
                document.getElementById('matrixContent').innerHTML = '<div class="error">加载T型报价表数据失败</div>';
            }
        }
        
        // 查看希腊值
        async function viewGreeks(symbol) {
            currentOption = { symbol: symbol };
            
            // 显示希腊值面板
            document.getElementById('greekPanel').style.display = 'block';
            document.getElementById('volatilityChartContainer').style.display = 'none';
            document.getElementById('cycleSelector').style.display = 'none';
            document.getElementById('matrixContainer').style.display = 'none';
            
            // 滚动到希腊值面板位置
            document.getElementById('greekPanel').scrollIntoView({ behavior: 'smooth' });
            
            // 加载希腊值数据
            loadGreeks(symbol);
        }
        
        // 加载希腊值数据
        async function loadGreeks(symbol) {
            try {
                const greekContainer = document.getElementById('greekContent');
                greekContainer.innerHTML = '<div class="loading">加载希腊值数据中...</div>';
                
                // 模拟希腊值数据
                const greekData = generateMockGreekData();
                
                // 渲染希腊值
                greekContainer.innerHTML = `
                    <div class="greek-item">
                        <div class="greek-value">${greekData.delta.toFixed(2)}</div>
                        <div class="greek-label">Delta</div>
                    </div>
                    <div class="greek-item">
                        <div class="greek-value">${greekData.gamma.toFixed(2)}</div>
                        <div class="greek-label">Gamma</div>
                    </div>
                    <div class="greek-item">
                        <div class="greek-value">${greekData.vega.toFixed(2)}</div>
                        <div class="greek-label">Vega</div>
                    </div>
                    <div class="greek-item">
                        <div class="greek-value">${greekData.theta.toFixed(2)}</div>
                        <div class="greek-label">Theta</div>
                    </div>
                `;
            } catch (error) {
                console.error('加载希腊值数据失败:', error);
                document.getElementById('greekContent').innerHTML = '<div class="error">加载希腊值数据失败</div>';
            }
        }
        
        // 生成模拟波动率数据
        function generateMockVolatilityData() {
            const data = [];
            const now = new Date();
            
            for (let i = 30; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000); // 每分钟一个点
                const volatility = 20 + Math.random() * 10; // 20-30%的波动率
                
                data.push({
                    time: time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    volatility: volatility
                });
            }
            
            return data;
        }
        
        // 生成模拟T型报价表数据
        function generateMockMatrixData() {
            const data = [];
            const baseStrike = 1000;
            
            for (let i = -5; i <= 5; i++) {
                const strikePrice = baseStrike + i * 10;
                const callPrice = Math.max(0, baseStrike - strikePrice + 50 + Math.random() * 20);
                const putPrice = Math.max(0, strikePrice - baseStrike + 50 + Math.random() * 20);
                
                data.push({
                    strikePrice: strikePrice,
                    callPrice: callPrice,
                    putPrice: putPrice,
                    callVolume: Math.floor(Math.random() * 1000),
                    putVolume: Math.floor(Math.random() * 1000)
                });
            }
            
            return data;
        }
        
        // 生成模拟希腊值数据
        function generateMockGreekData() {
            return {
                delta: 0.5 + (Math.random() - 0.5) * 0.4, // -0.2 到 0.8
                gamma: 0.02 + Math.random() * 0.03, // 0.02 到 0.05
                vega: 0.1 + Math.random() * 0.2, // 0.1 到 0.3
                theta: -0.05 - Math.random() * 0.05 // -0.05 到 -0.1
            };
        }
        
        // 获取期权名称
        function getOptionName(symbol) {
            const names = {
                "BTC_OPTION": "比特币期权",
                "ETH_OPTION": "以太坊期权",
                "AAPL_OPTION": "苹果期权",
                "GOOGL_OPTION": "谷歌期权"
            };
            
            return names[symbol] || symbol;
        }
    </script>
</body>
</html>